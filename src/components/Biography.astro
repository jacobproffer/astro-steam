---
import Section from "@components/Section.astro";
import Globe from "@assets/img/globe.svg";
import Person from "@assets/img/person.svg";
import playTime from "@utils/playTime.js";
import type { OwnedGame } from "../types/steam";

interface Props {
  location: string;
  joined: string;
  personaname?: string;
  games?: OwnedGame[];
}

const { location, joined, personaname, games = [] } = Astro.props;

// Calculate account statistics
const yearsOnSteam = joined
  ? (() => {
      const joinedDate = new Date(parseInt(joined) * 1000);
      const now = new Date();
      let years = now.getFullYear() - joinedDate.getFullYear();

      // Adjust if the current date hasn't reached the anniversary yet this year
      const monthDiff = now.getMonth() - joinedDate.getMonth();
      const dayDiff = now.getDate() - joinedDate.getDate();

      if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
        years--;
      }

      return years;
    })()
  : 0;

const totalGames = games.length;

const totalMinutes = games.reduce(
  (sum, game) => sum + (game.playtime_forever ?? 0),
  0
);

const mostPlayedGame =
  games.length > 0
    ? (() => {
        const topGame = games.reduce((max, game) =>
          (game.playtime_forever ?? 0) > (max.playtime_forever ?? 0)
            ? game
            : max
        );
        // Only return if it has actual playtime
        return (topGame.playtime_forever ?? 0) > 0 ? topGame : null;
      })()
    : null;

// Generate dynamic biography text
const accountSummary =
  personaname && yearsOnSteam > 0 && totalGames > 0
    ? `${personaname} has been a Steam member for ${yearsOnSteam} ${yearsOnSteam === 1 ? "year" : "years"} with ${totalGames} ${totalGames === 1 ? "game" : "games"} in their library.`
    : "";

const gamingHabits =
  mostPlayedGame && totalMinutes > 0
    ? `With ${playTime(totalMinutes)} played, their most-played game is ${mostPlayedGame.name} at ${playTime(mostPlayedGame.playtime_forever ?? 0)}.`
    : "";
---

<Section headline="Biography">
  <ul class="max-w-max flex max-md:flex-col md:items-center gap-6 max-md:gap-2">
    {
      location && (
        <li class="flex items-center gap-2">
          <Globe width={13} height={14} aria-hidden="true" />
          Located in the <span class="text-blue">{location}</span>
        </li>
      )
    }
    {
      joined && (
        <li class="flex items-center gap-2">
          <Person width={13} height={14} aria-hidden="true" />
          Joined Steam on{" "}
          <time
            class="text-blue"
            datetime={new Date(parseInt(joined) * 1000).toISOString()}
          >
            {new Date(parseInt(joined) * 1000).toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            })}
          </time>
        </li>
      )
    }
  </ul>
  {
    (accountSummary || gamingHabits) && (
      <p class="max-w-prose">
        {accountSummary} {gamingHabits}
      </p>
    )
  }
</Section>
