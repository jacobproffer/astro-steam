---
import { Image } from "astro:assets";
import BaseLayout from "@layouts/BaseLayout.astro";
import Section from "@components/Section.astro";
import Logo from "@assets/img/logo.svg";
import Globe from "@assets/img/globe.svg";
import Person from "@assets/img/person.svg";
import L4D from "@assets/img/left-4-dead-2-thumbnail.jpg";
import Arma3 from "@assets/img/arma-3-thumbnail.jpg";

const key = import.meta.env.STEAM_API_KEY;
const steamID = import.meta.env.STEAM_USER_ID;

console.log("Steam API Key exists:", !!key);
console.log("Steam ID exists:", !!steamID);

// Fetch user profile
const profileURL = `https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=${key}&steamids=${steamID}`;
const profileResponse = await fetch(profileURL);
const profileData = await profileResponse.json();
console.log("Profile data:", profileData);
const player = profileData?.response?.players[0];

// Fetch recent games
const gamesURL = `https://api.steampowered.com/IPlayerService/GetRecentlyPlayedGames/v0001/?key=${key}&steamid=${steamID}`;
const gamesResponse = await fetch(gamesURL);
const gamesData = await gamesResponse.json();
const games = gamesData?.response?.games;

// Determine status
let statusClass = "not-playing";
let headline = "Offline";
let status = "";

const userName = player?.realname;
const userIsPlaying = player?.gameextrainfo;
const userIsPlayingId = player?.gameid;
const userStatus = player?.personastate;
const userAvatar = player?.avatarfull;
const userURL = player?.profileurl;
const userLastOnline = player?.lastlogoff;

if (userIsPlaying) {
  statusClass = "text-green";
  headline = `${userName} is online`;
  status = `Currently playing <a href="https://store.steampowered.com/app/${userIsPlayingId}" target="_blank">${userIsPlaying}</a>.`;
} else if (userStatus > 0) {
  statusClass = "text-yellow";
  headline = `${userName} is online`;
  status = "Currently on the Steam dashboard.";
} else {
  statusClass = "text-red";
  headline = "Offline";
  const lastOnlineDate = userLastOnline
    ? new Date(userLastOnline * 1000)
    : null;
  const lastOnlineISO = lastOnlineDate?.toISOString();
  const lastOnlineFormatted = lastOnlineDate?.toLocaleString("en-US", {
    month: "long",
    day: "numeric",
    year: "numeric",
    hour: "numeric",
    minute: "2-digit",
  });
  status = `${lastOnlineDate ? ` Last seen <time datetime="${lastOnlineISO}">${lastOnlineFormatted}</time>.` : ""}`;
}

const pageTitle = `What is ${userName} Playing`;

console.log(userStatus);
---

<BaseLayout pageTitle={pageTitle}>
  <header
    class="absolute top-0 left-0 flex items-center justify-between w-full md:w-1/2 h-auto py-4 px-6"
  >
    <Logo width={50} height={33} />
    <a
      class="flex items-center gap-2"
      href={userURL}
      target="_blank"
      rel="noopener noreferrer"
    >
      {
        userAvatar && (
          <img
            class="w-10 h-10 rounded-full"
            src={userAvatar}
            alt=""
            loading="eager"
          />
        )
      }
      View Steam Profile
    </a>
  </header>
  <main class="grid md:grid-cols-2 h-full">
    <section class="flex items-center justify-center overflow-auto">
      <div class="flex flex-col gap-2">
        <h1 class="text-6xl">{headline}</h1>
        {status && <p class={statusClass} set:html={status} />}
      </div>
    </section>
    <div class="flex flex-col gap-4 py-4 px-6">
      <Section headline="Biography">
        <ul class="flex items-center gap-4">
          <li class="flex items-center gap-2">
            <Globe width={13} height={14} aria-hidden="true" />
            Located in the US
          </li>
          <li class="flex items-center gap-2">
            <Person width={13} height={14} aria-hidden="true" />
            Joined Steam in 2004
          </li>
        </ul>
        <p>
          In 2004, I joined the PC gaming community with Counter Strike:
          Condition Zero and Counter Strike: Source. Primarily, I play first
          person shooter and zombie themed games, such as Arma 3 and Left 4 Dead
          2.
        </p>
      </Section>
      <Section headline="Favorite Games">
        <ul class="grid md:grid-cols-2 items-center gap-4">
          <li>
            <Image
              class="border border-gray"
              src={L4D}
              alt="Left 4 Dead 2"
              widths={[230, 460]}
              sizes={`(max-width: 767px) 230px, 460px`}
            />
          </li>
          <li>
            <Image
              class="border border-gray"
              src={Arma3}
              alt="Arma 3"
              widths={[230, 460]}
              sizes={`(max-width: 767px) 230px, 460px`}
            />
          </li>
        </ul>
      </Section>
    </div>
  </main>
</BaseLayout>
