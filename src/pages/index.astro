---
import BaseLayout from "@layouts/BaseLayout.astro";
import Backgrounds from "@components/Backgrounds.astro";
import Header from "@components/Header.astro";
import Grid from "@components/Grid.astro";
import Hero from "@components/Hero.astro";
import Panel from "@components/Panel.astro";
import Biography from "@components/Biography.astro";
import Favorites from "@components/Favorites.astro";
import RecentGames from "@components/RecentGames.astro";
import Information from "@components/Information.astro";
import {
  fetchPlayerProfile,
  fetchRecentlyPlayedGames,
  fetchOwnedGames,
} from "@utils/steamAPI.js";
import { determineUserStatus } from "@utils/userStatus.js";
import type { SteamPlayer, Game, OwnedGame } from "../types/steam";

const key = import.meta.env.STEAM_API_KEY;
const steamID = import.meta.env.STEAM_USER_ID;

// Fetch user data with error handling
let player: SteamPlayer | null = null;
let games: Game[] | null = null;
let ownedGames: OwnedGame[] | null = null;
let topGames: OwnedGame[] = [];

try {
  player = await fetchPlayerProfile(key, steamID);
  games = await fetchRecentlyPlayedGames(key, steamID);
  ownedGames = await fetchOwnedGames(key, steamID);

  // Get top 3 games by playtime using a single-pass selection algorithm
  if (ownedGames && ownedGames.length > 0) {
    const top3: OwnedGame[] = [];

    for (const game of ownedGames) {
      // Only consider games with playtime
      if (game.playtime_forever === 0) continue;

      // Find insertion position
      let insertIndex = top3.length;
      for (let i = 0; i < top3.length; i++) {
        if (game.playtime_forever > top3[i].playtime_forever) {
          insertIndex = i;
          break;
        }
      }

      // Insert if within top 3
      if (insertIndex < 3) {
        top3.splice(insertIndex, 0, game);
        if (top3.length > 3) top3.pop();
      }
    }

    topGames = top3;
  }
} catch (error) {
  console.error("Error fetching Steam data:", error);
}

// Extract user data
const userName = player?.realname;
const userPersonaName = player?.personaname;
const userIsPlaying = player?.gameextrainfo;
const userAvatar = player?.avatarfull;
const userURL = player?.profileurl;
const userCountry = player?.loccountrycode;
const userJoined = player?.timecreated;

// Determine status
const { statusClass, headline, status } = determineUserStatus(player);

const pageTitle = `What is ${userName} Playing`;
---

<BaseLayout pageTitle={pageTitle}>
  <Header userURL={userURL} userAvatar={userAvatar} />
  <Grid>
    <Hero statusClass={statusClass} status={status} headline={headline} />
    <Panel>
      <Biography
        location={userCountry || ""}
        joined={userJoined?.toString() || ""}
        personaname={userPersonaName}
        games={ownedGames || []}
      />
      <Favorites games={topGames} />
      <RecentGames games={games || []} />
      <Information />
    </Panel>
    <Backgrounds currentGame={userIsPlaying || ""} />
  </Grid>
</BaseLayout>
