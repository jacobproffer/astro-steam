---
import BaseLayout from "@layouts/BaseLayout.astro";
import Logo from "@assets/Logo.svg";

const key = import.meta.env.STEAM_API_KEY;
const steamID = import.meta.env.STEAM_USER_ID;

// Fetch user profile
const profileURL = `https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=${key}&steamids=${steamID}`;
const profileResponse = await fetch(profileURL);
const profileData = await profileResponse.json();
const player = profileData?.response?.players[0];

// Fetch recent games
const gamesURL = `https://api.steampowered.com/IPlayerService/GetRecentlyPlayedGames/v0001/?key=${key}&steamid=${steamID}`;
const gamesResponse = await fetch(gamesURL);
const gamesData = await gamesResponse.json();
const games = gamesData?.response?.games;

// Determine status
let statusClass = "not-playing";
let headline = "Offline";
let status = "";

const userName = player?.realname;
const userIsPlaying = player?.gameextrainfo;
const userIsPlayingId = player?.gameid;
const userStatus = player?.personastate;
const userAvatar = player?.avatarfull;
const userURL = player?.profileurl;

if (userIsPlaying) {
  statusClass = "playing";
  headline = `${userName} is online`;
  status = `Currently playing <a href="https://store.steampowered.com/app/${userIsPlayingId}" target="_blank">${userIsPlaying}</a>.`;
} else if (userStatus > 0) {
  statusClass = "not-playing-but-online";
  headline = `${userName} is online`;
  status = "Currently on the Steam dashboard.";
}

const pageTitle = `What is ${userName} Playing`;

console.log(userStatus);
---

<BaseLayout pageTitle={pageTitle}>
  <div class={statusClass}>
    <header>
      <div class="flex items-center justify-between">
        <Logo width={50} height={33} />
        <a
          class="flex items-center gap-2"
          href={userURL}
          target="_blank"
          rel="noopener noreferrer"
        >
          {
            userAvatar && (
              <img class="w-10 h-10 rounded-full" src={userAvatar} alt="" />
            )
          }
          View Steam Profile
        </a>
      </div>
    </header>
    <main>
      <h1 class="text-6xl">{headline}</h1>
      {status && <p set:html={status} />}
    </main>
  </div>
</BaseLayout>
